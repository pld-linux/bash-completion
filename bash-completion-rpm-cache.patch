--- bash-completion/bash_completion~	2009-04-02 18:56:57.000000000 +0300
+++ bash-completion/bash_completion	2009-04-02 18:58:54.003383671 +0300
@@ -1836,29 +1836,26 @@
 #
 _rpm_installed_packages()
 {
-	local ver nodig nosig
+	# if rpm (4.4.7+) is configured to export it's rpmdb to /var/cache/hrmib (%_hrmib_path)
+	if [ -d /var/cache/hrmib -a -r /var/cache/hrmib ]; then
+		COMPREPLY=( $( LC_ALL=C command ls -1 /var/cache/hrmib | sed -ne '/^'$cur'/p') )
+		return
+	fi
+
+	# refresh cache if writable
+	if [ /var/log/rpmpkgs -ot /var/lib/rpm/Packages -a -w /var/log/rpmpkgs ]; then
+		# we grab the output to local variable to prevent possible race
+		local tmp=$(rpm -qa --nodigest --nosignature --qf '%{name}-%{version}-%{release}.%{arch}.rpm\n' | LC_ALL=C sort)
+		echo "$tmp" > /var/log/rpmpkgs
+	fi
 
-	if [ -r /var/log/rpmpkgs -a \
-		/var/log/rpmpkgs -nt /var/lib/rpm/Packages ]; then
+	if [ -r /var/log/rpmpkgs -a /var/log/rpmpkgs -nt /var/lib/rpm/Packages ]; then
 		# using RHL 7.2 or later - this is quicker than querying the DB
 		COMPREPLY=( $( sed -ne \
-		's|^\('$cur'.*\)-[0-9a-zA-Z._]\+-[0-9a-z.@]\+.*\.rpm$|\1|p' \
-				/var/log/rpmpkgs ) )
+ 		's|^\('$cur'.*\)\.rpm$|\1|p' \
+				/var/log/rpmpkgs ) )
 	else
-		nodig=""
-		nosig=""
-		ver=$(rpm --version)
-		ver=${ver##* }
-
-		if [[ "$ver" > "4.0.4" ]]; then
-			nodig="--nodigest"
-		fi
-		if [[ "$ver" > "4.0.99" ]]; then
-			nosig="--nosignature"
-		fi
-
-		COMPREPLY=( $( rpm -qa $nodig $nosig | sed -ne \
-		's|^\('$cur'.*\)-[0-9a-zA-Z._]\+-[0-9a-z.@]\+$|\1|p' ) )
+ 		COMPREPLY=( $( rpm -qa --nodigest --nosignature --qf '%{name}-%{version}-%{release}.%{arch}\n' "$cur*" ) )
 	fi
 }
 
