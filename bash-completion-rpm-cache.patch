--- bash-completion-1.0/bash_completion~	2009-04-13 16:21:42.000000000 +0300
+++ bash-completion-1.0/bash_completion	2009-04-13 16:28:42.911409892 +0300
@@ -1940,17 +1940,30 @@
 #
 _rpm_installed_packages()
 {
-	local ver nodig="$1" nosig="$2"
+	local nodig="$1" nosig="$2"
 
-	if [ -r /var/log/rpmpkgs -a \
-		/var/log/rpmpkgs -nt /var/lib/rpm/Packages ]; then
+	# if rpm (4.4.7+) is configured to export it's rpmdb to /var/cache/hrmib (%_hrmib_path)
+	if [ -d /var/cache/hrmib -a -r /var/cache/hrmib ]; then
+		COMPREPLY=( $( LC_ALL=C command ls -1 /var/cache/hrmib | sed -ne '/^'$cur'/p') )
+		return
+	fi
+
+	# refresh cache if writable
+	if [ -w /var/cache/rpmpkgs.txt -a /var/cache/rpmpkgs.txt -ot /var/lib/rpm/Packages ]; then
+		# we grab the output to local variable to prevent possible race
+		_rpm_nodigsig
+		local tmp=$(rpm -qa $nodig $nosig --qf '%{name}-%{version}-%{release}.%{arch}.rpm\n')
+		echo "$tmp" > /var/cache/rpmpkgs.txt
+	fi
+
+	if [ -r /var/cache/rpmpkgs.txt -a /var/cache/rpmpkgs.txt -nt /var/lib/rpm/Packages ]; then
 		# using RHL 7.2 or later - this is quicker than querying the DB
 		COMPREPLY=( $( sed -ne \
-		's|^\('$cur'[^[:space:]]*\)-[^[:space:]-]\+-[^[:space:]-]\+\.rpm$|\1|p' \
-				/var/log/rpmpkgs ) )
+ 		's|^\('$cur'.*\)\.rpm$|\1|p' \
+				/var/cache/rpmpkgs.txt ) )
 	else
 		_rpm_nodigsig
-		COMPREPLY=( $( rpm -qa $nodig $nosig --qf='%{NAME} ' "$cur*" ) )
+ 		COMPREPLY=( $( rpm -qa $nodig $nosig --qf '%{name}-%{version}-%{release}.%{arch}\n' "$cur*" ) )
 	fi
 }
 
